from flask import Flask, request, jsonify, render_template
from flask_sqlalchemy import SQLAlchemy
from datetime import datetime
import http.client
import json
import time

app = Flask(__name__)

app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///metapython.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)
bandera = False

class Log(db.Model):
    id = db.Column(db.Integer,primary_key=True)
    fecha_y_hora = db.Column(db.DateTime, default=datetime.utcnow)
    texto = db.Column(db.TEXT)
    
with app.app_context():
    db.create_all()
    
#Funcion para ordenar los registros por fecha y hora
def ordenar_por_fecha_y_hora(registros):
    return sorted(registros, key=lambda x: x.fecha_y_hora,reverse=True)

@app.route('/')
def index():
    #obtener todos los registros ed la base de datos
    registros = Log.query.all()
    registros_ordenados = ordenar_por_fecha_y_hora(registros)
    return render_template('index.html',registros=registros_ordenados)

mensajes_log = []

#Funcion para agregar mensajes y guardar en la base de datos
def agregar_mensajes_log(texto):
    mensajes_log.append(texto)

    #Guardar el mensaje en la base de datos
    nuevo_registro = Log(texto=texto)
    db.session.add(nuevo_registro)
    db.session.commit()

TOKEN_MC = "MOUNTAINCONQUEROR"

@app.route('/webhook', methods=['GET','POST'])
def webhook():
    if request.method == 'GET':
        challenge = verificar_token(request)
        return challenge
    elif request.method == 'POST':
        reponse = recibir_mensajes(request)
        return reponse

def verificar_token(req):
    token = req.args.get('hub.verify_token')
    challenge = req.args.get('hub.challenge')

    if challenge and token == TOKEN_MC:
        return challenge
    else:
        return jsonify({'error':'Token Invalido'}),401

def recibir_mensajes(req):
    try:
        req = request.get_json()
        entry =req['entry'][0]
        changes = entry['changes'][0]
        value = changes['value']
        objeto_mensaje = value['messages']

        if objeto_mensaje:
            messages = objeto_mensaje[0]

            if "type" in messages:
                tipo = messages["type"]

                #Guardar Log en la BD
                agregar_mensajes_log(json.dumps(messages))

                if tipo == "interactive":
                    tipo_interactivo = messages["interactive"]["type"]

                    if tipo_interactivo == "button_reply":
                        text = messages["interactive"]["button_reply"]["id"]
                        numero = messages["from"]

                        enviar_mensajes_whatsapp(text,numero)
                    
                    elif tipo_interactivo == "list_reply":
                        text = messages["interactive"]["list_reply"]["id"]
                        numero = messages["from"]

                        enviar_mensajes_whatsapp(text,numero)

                if "text" in messages:
                    text = messages["text"]["body"]
                    numero = messages["from"]

                    enviar_mensajes_whatsapp(text,numero)

                    #Guardar Log en la BD
                    agregar_mensajes_log(json.dumps(messages))

        return jsonify({'message':'EVENT_RECEIVED'})
    except Exception as e:
        return jsonify({'message':'EVENT_RECEIVED'})

def enviar_mensajes_whatsapp(texto,number):
    texto = texto.lower()

    if "hola" in texto:
        data={
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "üöÄ Hola, ¬øC√≥mo est√°s? Bienvenido."
            }
        }
    elif "1" in texto:
        data={
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "text": {
                "preview_url": True,
                "body": "Estos ser√°n nuestros pr√≥ximos tours! https://mountainconqueror.club/tours"
            }
        }
    elif "2" in texto:
        data = {
            "messaging_product": "whatsapp",
            "to": number,
            "type": "location",
            "location": {
                "latitude": "14.622405",
                "longitude": "-90.549373",
                "name": "Punto de reuni√≥n Centro Comercial Rus Mall",
                "address": "Centro Comercial Rus Mall"
            }
        }
    elif "3" in texto:
        data = {
            "messaging_product": "whatsapp",
            "to": number,
            "type": "location",
            "location": {
                "latitude": "14.854814",
                "longitude": "-91.536485",
                "name": "Punto de reuni√≥n Shell ‚Ä¢ Rotonda Paseo Las Americas",
                "address": "Shell ‚Ä¢ Rotonda Paseo Las Americas"
            }
        }
    elif "4" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "üôã‚Äç‚ôÇÔ∏è Hola soy asistente de Sebas, lamento que no hayas encontrado la informaci√≥n que buscabas y solicitas apoyo para resolver tus dudas. \n\nüìå *Puedes escribir al n√∫mero personal y con gusto te atender√°.* \n\n +502 34267938"
            }
        }    
    elif "5" in texto:
        data ={
            "messaging_product": "whatsapp",
            "to": number,
            "type": "interactive",
            "interactive":{
                "type" : "list",
                "body": {
                    "text": "Seleccionar Lista"
                },
                "footer": {
                    "text": "Selecciona el listado de eventos pr√≥ximos"
                },
                "action":{
                    "button":"Ver Eventos",
                    "sections":[
                        {
                            "title":"Eventos",
                            "rows":[
                                {
                                    "id":"b",
                                    "title" : "Febrero 09",
                                    "description": "(Atardecer) Volc√°n Pacaya"
                                },
                                {
                                    "id":"c",
                                    "title" : "Febrero 08 - 09",
                                    "description": "(Ruta Alotenango - Asalto) Volc√°n Acatenango"
                                },
                                {
                                    "id":"d",
                                    "title" : "Febrero 15 - 16",
                                    "description": "(Ruta Turistica - Asalto Nocturno) Volc√°n Santa Mar√≠a + Campana Abaj"
                                },
                                {
                                    "id":"e",
                                    "title" : "Febrero 15 - 16",
                                    "description": "(Ruta La Viergen - Asalto Nocturno) Volc√°n Santa Mar√≠a + Campana Abaj"
                                },
                                {
                                    "id":"f",
                                    "title" : "Febrero 21 - 23",
                                    "description": "Volc√°n Tajumulco (Asalto - Ruta San Sebasti√°n con acercamiento de 4x4)"
                                },
                                {
                                    "id":"g",
                                    "title" : "Febrero 22 - 23",
                                    "description": "Semuc Champey (Express)"
                                },
                                {
                                    "id":"h",
                                    "title" : "Abril 17 - 20",
                                    "description": "Trekking Ixil"
                                },
                                {
                                    "id":"i",
                                    "title" : "Abril 14 - 20",
                                    "description": "Expedici√≥n La Danta (Semana Santa - Todo Incluido)"
                                }
                            ]
                        },{
                            "title":"Retos",
                            "rows":[
                                {
                                    "id":"w",
                                    "title" : "Reto Chivo",
                                    "description": "37 Cumbres 2025 (Guatemala) - Salida desde Xela"
                                }
                            ]
                        },{
                            "title":"Trail Running",
                            "rows":[
                                {
                                    "id":"t",
                                    "title" : "Abril 13 2025(X SkyRace)",
                                    "description": "Evento de Trail running (X SkyRace) con distancias de 10K 14K 24K 42K"
                                }
                            ]
                        }
                    ]
                }
            }
        }
    elif "0" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "üöÄ *¬°Hola!* Gracias por comunicarte con nosotros\n\nüìå *Selecciona una opci√≥n del men√∫ para continuar:*\n\n1Ô∏è‚É£ Pr√≥ximos Eventos ‚ùî\n2Ô∏è‚É£ Salida desde la Capital üìç\n3Ô∏è‚É£ Salida desde Xela üìç\n4Ô∏è‚É£ Hablar con un operador üôã‚Äç‚ôÇÔ∏è\n5Ô∏è‚É£ Informaci√≥n de Eventos y Retos üåã\n0Ô∏è‚É£ Regresar al Men√∫ üïú\n\n‚ú® *Escribe el n√∫mero de la opci√≥n que deseas y te ayudaremos de inmediato.* \n\n\n üåê Visita nuestro sitio web:\n mountainconqueror.club"
            }
        }
    elif "boton" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "interactive",
            "interactive":{
                "type":"button",
                "body": {
                    "text": "¬øConfirmas tu registro?"
                },
                "footer": {
                    "text": "Selecciona una de las opciones"
                },
                "action": {
                    "buttons":[
                        {
                            "type": "reply",
                            "reply":{
                                "id":"btnsi",
                                "title":"Si"
                            }
                        },{
                            "type": "reply",
                            "reply":{
                                "id":"btnno",
                                "title":"No"
                            }
                        },{
                            "type": "reply",
                            "reply":{
                                "id":"btntalvez",
                                "title":"Tal Vez"
                            }
                        }
                    ]
                }
            }
        }
    elif "btnsi" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                
                "preview_url": False,
                "body": "!Bienvenid@ a la aventura!. \n\n "
                "**INSCRIPCI√ìN** \n"
                "Banco Promerica ‚Äî \n"
                "Titular: SEBASTIAN LORENZO LOPEZ\n"
                "Tipo: Ahorro ‚Äî N√∫mero: 32992082536883\n"

                "Banco Industrial ‚Äî\n"
                "Titular: SEBASTIAN LORENZO LOPEZ\n"
                "Tipo: Ahorro ‚Äî N√∫mero: 3698864\n"

                "Proceso ùêùùêû ùê©ùêöùê†ùê®:\n"
                "1.- Realizar dep√≥sito o reserva.\n"
                "2.- Tomar Foto o escanear boleta de pago.\n"
                "3.- LLenar el formulario de participaci√≥n:\n"
                "https://forms.gle/gdUL8iduCiK8VUYF9 \n"
            }
        }
    elif "btnno" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "Es una Lastima, igual te dejar√© nuestros pr√≥ximos tours! https://mountainconqueror.club/tours ."
            }
        }
    elif "btntalvez" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "Estare a al pendiente, si tienes dudas especificas que no encuentras en el documento, puedes escribir al +502 34267938."
            }
        }
        

    elif "b" == texto.strip():
        bandera = True
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/events/1.Volcan_Pacaya_Atardecer.pdf",
                "caption": (
                    "üåãüî• *¬°Vive la Experiencia del Volc√°n Pacaya!* üî•üåã\n\n"
                    "üöÄ √önete a una **aventura inolvidable** explorando uno de los volcanes m√°s impresionantes de Guatemala. "
                    "Disfruta de paisajes espectaculares, senderos rodeados de lava petrificada y una vista incre√≠ble de la actividad volc√°nica. üåÑüî•\n\n"
                    "üìå **Incluye:**\n"
                    "‚úîÔ∏è Transporte ida y vuelta üöå\n"
                    "‚úîÔ∏è Gu√≠as expertos üèûÔ∏è\n"
                    "‚úîÔ∏è Experiencia √∫nica con vistas panor√°micas üåÖ\n"
                    "‚úîÔ∏è Oportunidad de asar malvaviscos en la lava caliente üî•\n\n"
                    "üéüÔ∏è *Reserva tu cupo ahora y prep√°rate para una experiencia √©pica.*\n"
                    "üìÖ Fecha: Febrero 09\n"
                    "üí∞ Costo: Q160\n\n"
                    "üì≤ *¬°Escr√≠benos para m√°s informaci√≥n y asegura tu lugar!* üèîÔ∏è‚ú®\n\n"
                    "#Volc√°nPacaya #Aventura√âpica #Monta√±ismoGuatemala #Pasi√≥nPorLaNaturaleza #ViajaConNosotros"
                )
            }
        }
    elif "c" == texto.strip():
        bandera = True
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/events/2.Acatenango_Ruta_Alotenango.pdf",
                "caption": (
                    "üåãüî• *¬°Desaf√≠o Extremo en el Volc√°n Acatenango por la Ruta Alotenango!* üî•üåã\n\n"
                    "Este no es un ascenso cualquiera, es una *aventura extrema* reservada para los m√°s valientes y experimentados. "
                    "La *Ruta Alotenango* es conocida por ser desafiante, intensa y llena de emociones que pondr√°n a prueba tu resistencia f√≠sica y mental. üèîÔ∏èüí™\n\n"
                    "Si buscas superar tus l√≠mites, atravesar terrenos empinados y disfrutar de vistas espectaculares mientras conquistas una de las "
                    "cumbres m√°s imponentes de Guatemala, *esta es tu oportunidad*. üåÑ‚ú®\n\n"
                    "‚ö†Ô∏è *No apto para principiantes*: Este desaf√≠o requiere experiencia previa en monta√±ismo, excelente condici√≥n f√≠sica y determinaci√≥n "
                    "para enfrentar uno de los ascensos m√°s intensos de la regi√≥n.\n\n"
                    "‚ùì *¬øEst√°s listo para el reto?* ¬°√önete y demuestra de qu√© est√°s hecho en esta aventura inolvidable! üî•üêæ\n\n"
                    "#AcatenangoExtremo #RutaAlotenango #Aventura√âpica #Monta√±ismoGuatemala #Desaf√≠oDeAltura #NoParaPrincipiantes #ConquistaLasCimas"
                )
            }
        }
    elif "d" == texto.strip():
        bandera = True
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/events/3.Volcan_Santa_Maria_Turistica.pdf",
                "caption": (
                    "üåã‚ú® *¬°Aventura en el Volc√°n Santa Mar√≠a y Campana Abaj!* ‚ú®üåã\n\n"
                    "Prep√°rate para explorar una de las rutas m√°s espectaculares y accesibles de Guatemala: el *Volc√°n Santa Mar√≠a* "
                    "y la m√°gica experiencia en *Campana Abaj*. Este recorrido tur√≠stico combina paisajes impresionantes, historia cultural "
                    "y la belleza natural que solo este destino puede ofrecer. üèîÔ∏èüåø\n\n"
                    "üîπ *Volc√°n Santa Mar√≠a*: Con una de las vistas m√°s impresionantes hacia el volc√°n activo *Santiaguito*, este coloso "
                    "es una parada obligatoria para los amantes de las alturas y la naturaleza. üåÑüî•\n"
                    "üîπ *Campana Abaj*: Un lugar lleno de misticismo y tradici√≥n que conecta a los visitantes con la cultura y el legado "
                    "ancestral de la regi√≥n. Una experiencia inolvidable rodeada de paisajes √∫nicos. ‚ú®üå≥\n\n"
                    "‚ùì *¬øListo para esta aventura tur√≠stica?* √önete a este recorrido que combina naturaleza, cultura y la magia de nuestras "
                    "monta√±as. Una oportunidad para disfrutar del esplendor de Guatemala en su m√°ximo esplendor. üí™üêæ\n\n"
                    "#Volc√°nSantaMar√≠a #CampanaAbaj #AventuraTur√≠stica #NaturalezaYTradici√≥n #Monta√±ismoGuatemala #Pasi√≥nPorLaCultura"
                )
            }
        }
    elif "e" == texto.strip():
        bandera = True
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/events/4.Volcan_Santa_Maria_Ruta_La_Virgen.pdf",
                "caption": (
                    "üåãüî• *¬°Aventura Extrema: Ruta La Virgen al Volc√°n Santa Mar√≠a!* üî•üåã\n\n"
                    "Para los m√°s valientes y audaces, presentamos *Ruta La Virgen*, un recorrido desafiante, poco explorado "
                    "y dise√±ado exclusivamente para los m√°s intr√©pidos. Esta nueva ruta hacia el imponente *Volc√°n Santa Mar√≠a* "
                    "promete poner a prueba tu resistencia y esp√≠ritu aventurero mientras descubres senderos ocultos y paisajes "
                    "que pocos han visto. üèîÔ∏èüí™‚ú®\n\n"
                    "Con *terrenos escarpados, inclinaciones pronunciadas y una conexi√≥n inigualable con la naturaleza*, *Ruta La Virgen* "
                    "es el desaf√≠o perfecto para quienes buscan algo m√°s all√° de lo ordinario. Cada paso ser√° un logro, y la recompensa "
                    "final ser√° una experiencia que marcar√° tu vida. üåÑüî•\n\n"
                    "‚ö†Ô∏è *No es para principiantes:* Este recorrido exige preparaci√≥n f√≠sica, determinaci√≥n y el alma de un verdadero explorador.\n\n"
                    "‚ùì *¬øTe atreves a ser parte de esta traves√≠a √©pica?* La cima del *Santa Mar√≠a* te espera para escribir una nueva historia de "
                    "superaci√≥n y aventura. üêæüî•\n\n"
                    "#RutaLaVirgen #Volc√°nSantaMar√≠a #AventuraExtrema #SoloParaIntrepidos #Monta√±ismoGuatemala #ConquistaLasAlturas"
                )
            }
        }
    elif "f" == texto.strip():
        bandera = True
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/events/5.Volcan_Tajumulco_Ruta_San_Sebastian_Nocturno.pdf",
                "caption": (
                    "üåãüî• *¬°Conquista el techo de Centroam√©rica: Volc√°n Tajumulco!* üî•üåã\n\n"
                    "Prep√°rate para una de las expediciones m√°s emblem√°ticas de Guatemala: el ascenso al *Volc√°n Tajumulco*, "
                    "el punto m√°s alto de toda Centroam√©rica con *4,220 metros sobre el nivel del mar*. üèîÔ∏è‚ú®\n\n"
                    "Esta traves√≠a te llevar√° a trav√©s de *impresionantes paisajes monta√±osos, bosques de altura y cielos despejados* "
                    "que regalan *amaneceres y atardeceres de ensue√±o*. Cada paso en esta aventura pondr√° a prueba tu resistencia, "
                    "pero la recompensa en la cima ser√° inigualable. üåÑüí™\n\n"
                    "üåü *Lo que te espera en el Tajumulco:*\n"
                    "üîπ *Ascenso desafiante* con vistas panor√°micas inigualables.\n"
                    "üîπ *Amanecer desde la cima*, un espect√°culo de colores y nubes danzando bajo tus pies.\n"
                    "üîπ *Conexi√≥n con la naturaleza* y el esp√≠ritu aventurero que llevas dentro.\n\n"
                    "‚úÖ *No te pierdas esta oportunidad de conquistar el techo de Centroam√©rica* y ser parte de una experiencia inolvidable. "
                    "¬øEst√°s listo para el reto? üöÄüî•\n\n"
                    "#Volc√°nTajumulco #TechoDeCentroam√©rica #Aventura√âpica #Monta√±ismoGuatemala #SuperandoL√≠mites #ConquistandoCimas"
                )
            }
        }
    elif "g" == texto.strip():
        bandera = True
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "caption": (
                    "üåä‚ú® *¬°Descubre el m√°gico Semuc Champey!* ‚ú®üåä\n\n"
                    "üåø Sum√©rgete en un para√≠so natural con **piscinas de agua turquesa**, impresionantes vistas y cuevas llenas de aventura. "
                    "Vive una experiencia inolvidable en uno de los destinos m√°s fascinantes de Guatemala. üåÑüíô\n\n"
                    
                    "üìÖ **Fecha:** Febrero 22 - 23\n"
                    "üïí **Hora de salida Capital:** 9:00 PM ‚è≥\n"
                    "üí∞ **Costo Capital:** Q295 üíµ\n\n"
                    "üïí **Hora de salida Xela:** 5:30 PM ‚è≥\n"
                    "üí∞ **Costo Xela:** Q695 üíµ\n\n"

                    "üìå **Incluye:** ‚úÖ\n"
                    "‚úîÔ∏è Transporte ida y vuelta üöê\n"
                    "‚úîÔ∏è Tour guiado por las pozas naturales üí¶\n"

                    "üö´ **No incluye:** ‚ùå\n"
                    "‚ùå Alimentaci√≥n üçΩÔ∏è\n"
                    "‚ùå Bebidas ü•§\n"
                    "‚ùå Gastos personales üõçÔ∏è\n\n"
                    "‚ùå Traslado de 4x4 Q20 por persona (debes cancelar en efectivo el d√≠a del viaje, directamente con nuestro staff).\n\n"
                    "‚ùå Visita a las **Cuevas de Kan‚ÄôBa** (opcional) üî¶ \n\n"
                    "‚ùå Tubing en el r√≠o Cahab√≥n üõ∂ (opcional) \n\n"
                    "‚ùå Ingreso al parque natural Semuc Champey. (Q30 nacional y 50 Extranjeros) üõçÔ∏è\n\n"

                    "üéüÔ∏è *Reserva tu cupo ahora y prep√°rate para una experiencia √©pica.*\n"
                    "üì≤ *¬°Escr√≠benos para m√°s informaci√≥n y asegura tu lugar!* üåéüî•\n\n"
                    "#SemucChampey #Aventura√âpica #GuatemalaM√°gica #ViajesIncre√≠bles #TurismoSostenible"
                )
            }
        }
    elif "i" == texto.strip():
        bandera = True
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "caption": (
                    "‚õ∞Ô∏èüèïÔ∏è *¬°Trekking Ixil ‚Äì Con√©ctate con la Naturaleza y la Cultura!* üèïÔ∏è‚õ∞Ô∏è\n\n"
                    "üöÄ Explora los majestuosos paisajes de la regi√≥n Ixil, un territorio lleno de historia, cultura y senderos escondidos "
                    "entre monta√±as, r√≠os y valles ancestrales. Vive una **aventura √∫nica** en este destino poco explorado. üåÑüî•\n\n"

                    "üìÖ **Fecha:** 17 - 20 Abril\n"
                    "üïí **Hora de salida:** 9:00 PM ‚è≥\n"
                    "üí∞ **Costo:** Q 875 üíµ\n\n"

                    "üìå **Incluye:** ‚úÖ\n"
                    "‚úîÔ∏è Transporte ida y vuelta üöê\n"
                    "‚úîÔ∏è Gu√≠as locales y narraci√≥n cultural üèûÔ∏è\n"
                    "‚úîÔ∏è Acceso a senderos exclusivos üåø\n"
                    "‚úîÔ∏è Experiencia en comunidades locales üè°\n"
                    "‚úîÔ∏è Seguro b√°sico de trekking üèïÔ∏è\n\n"

                    "üö´ **No incluye:** ‚ùå\n"
                    "‚ùå Alimentaci√≥n en el recorrido üçΩÔ∏è\n"
                    "‚ùå Hidrataci√≥n personal ü•§\n"
                    "‚ùå Gastos adicionales personales üè™\n\n"

                    "üéüÔ∏è *Camina por los senderos de la historia y la naturaleza.*\n"
                    "üì≤ *¬°Reserva tu cupo y √∫nete a esta experiencia √∫nica en el coraz√≥n de Guatemala!* üåéüî•\n\n"
                    "#TrekkingIxil #AventuraEnGuatemala #SenderosSagrados #Monta√±ismo #ExplorandoGuatemala"
                )
            }
        }
    elif "h" == texto.strip():
        bandera = True
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/events/La_Danta_Semana_Santa.pdf",
                "caption": (
                    "üèïÔ∏èüåø *¬°Expedici√≥n La Danta ‚Äì El Coraz√≥n de la Selva Maya!* üåøüèïÔ∏è\n\n"
                    "üöÄ Atr√©vete a una **aventura extrema** explorando el misterioso **Mirador y la Pir√°mide de La Danta**, "
                    "una de las m√°s grandes del mundo. Ad√©ntrate en la densa selva petenera y camina entre historia, naturaleza y desaf√≠os √∫nicos. üåéüî•\n\n"

                    "üìÖ **Fecha:** 14 - 20 Abril\n"
                    "üïí **Hora de salida:** 5:00 AM ‚è≥\n"
                    "üí∞ **Costo:** Q 3,650 üíµ\n\n"
                    "üí∞ **Si reservas antes del 15 de Marzo :** Q 3,450 üíµ\n\n"

                    "üìå **Incluye:** ‚úÖ\n"
                    "‚úîÔ∏è Transporte terrestre ida y vuelta üöê\n"
                    "‚úîÔ∏è Gu√≠as especializados en la selva üåø\n"
                    "‚úîÔ∏è Permiso de acceso a la reserva arqueol√≥gica üèõÔ∏è\n"
                    "‚úîÔ∏è Alimentaci√≥n en el campamento ü•ò\n"
                    "‚úîÔ∏è Equipo b√°sico de expedici√≥n üéí\n\n"

                    "üö´ **No incluye:** ‚ùå\n"
                    "‚ùå Equipo personal de camping ‚õ∫\n"
                    "‚ùå Snacks y bebidas adicionales ü•§\n"
                    "‚ùå Seguro de viaje üè•\n\n"

                    "üéüÔ∏è *Una expedici√≥n solo para verdaderos aventureros.*\n"
                    "üì≤ *¬°Reserva tu cupo y prep√°rate para explorar la historia en su m√°xima expresi√≥n!* üèïÔ∏èüî•\n\n"
                    "#Expedici√≥nLaDanta #AventuraMaya #SelvaPetenera #Monta√±ismoGuatemala #HistoriaYNaturaleza"
                )
            }
        }
    elif "z" == texto.strip():
        data={
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/rj.pdf",
                "caption": "Reto Jaguar"
            }
        }
    elif "y" == texto.strip():
        data={
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                    "link": "https://mountainconqueror.club/assets/document/rm.pdf",
                    "caption": "Reto Maya"
                }
            }
    elif "x" == texto.strip():
        data={
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/rt.pdf",
                "caption": "Reto Tigre"
            }
        }
    elif "w" == texto.strip():
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/rc.pdf",
                "caption": "Reto Chivo"
            }
        }
    elif "t" == texto.strip():
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "¬°Sum√©rgete en la emocionante experiencia de la X-SKYRACE! Este desaf√≠o te invita a conquistar elevaciones impresionantes y explorar la majestuosidad de terrenos monta√±osos a trav√©s de una competici√≥n de resistencia y determinaci√≥n. Prep√°rate para elevar tu esp√≠ritu y desafiar los l√≠mites en los 3 volcanes de Xela, Cerr√≥ Quemado, Santa Mar√≠a, Siete Orejas \n\n\n üåê Visita nuestra pagina:\n https://www.instagram.com/x_skyrace/"
            }
        }
    else:
        data={
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "üöÄ *¬°Hola!* Gracias por comunicarte con nosotros\n\nüìå *Selecciona una opci√≥n del men√∫ para continuar:*\n\n1Ô∏è‚É£ Pr√≥ximos Eventos ‚ùî\n2Ô∏è‚É£ Salida desde la Capital üìç\n3Ô∏è‚É£ Salida desde Xela üìç\n4Ô∏è‚É£ Hablar con un operador üôã‚Äç‚ôÇÔ∏è\n5Ô∏è‚É£ Informaci√≥n de Eventos y Retos üåã\n0Ô∏è‚É£ Regresar al Men√∫ üïú\n\n‚ú® *Escribe el n√∫mero de la opci√≥n que deseas y te ayudaremos de inmediato.* \n\n\n üåê Visita nuestro sitio web:\n mountainconqueror.club"
            }
        }

    data=json.dumps(data)
    
    data_boton = {
        "messaging_product": "whatsapp",
        "recipient_type": "individual",
        "to": number,
        "type": "interactive",
        "interactive": {
            "type": "button",
            "body": {
                "text": "\n\n ¬øConfirmas tu registro?"
            },
            "footer": {
                "text": "Selecciona una de las opciones"
            },
            "action": {
                "buttons": [
                    {
                        "type": "reply",
                        "reply": {
                            "id": "btnsi",
                            "title": "S√≠"
                        }
                    },
                    {
                        "type": "reply",
                        "reply": {
                            "id": "btnno",
                            "title": "No"
                        }
                    },{
                        "type": "reply",
                        "reply":{
                            "id":"btntalvez",
                            "title":"Tal Vez"
                        }
                    }
                ]
            }
        }
    }
    
    data_boton=json.dumps(data_boton)

    headers = {
        "Content-Type" : "application/json",
        "Authorization" : "Bearer EAA3DvBSFw0oBOy6TUbXILZCO6YoSvCxn8LZCyKvAbLGP1XQpHUtImCuPKSlDipQUdCMsOlhiWIY3V37L8YfshOpbxN95kqDBFepgnygzG0Nqv0DwQWZByqxCg4IKbpO00bVHnoSnX4k0EoKIJMyHYXYwHaJhoNPqs2TGUi5N8pRCaq2zDBbYZC2ZBXsSymiIahRzGfPZCwA4ol2PqiCAbseld5NZA0l1XzQs08ZAKZAYD"
    }

    connection = http.client.HTTPSConnection("graph.facebook.com")

    try:
        connection.request("POST","/v21.0/526518787218130/messages", data, headers)
        response = connection.getresponse()
        print(response.status, response.reason)
        
        
        if(bandera):
            time.sleep(10)
            bandera = False
        
            connection.request("POST","/v21.0/526518787218130/messages", data_boton, headers)
            response = connection.getresponse()
            print(response.status, response.reason)
        
    except Exception as e:
        agregar_mensajes_log(json.dumps(e))
    finally:
        connection.close()

if __name__=='__main__':
    app.run(host='0.0.0.0',port=80,debug=True)