from flask import Flask, request, jsonify, render_template
from flask_sqlalchemy import SQLAlchemy
from datetime import datetime
import http.client
import json

app = Flask(__name__)

app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///metapython.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)

class Log(db.Model):
    id = db.Column(db.Integer,primary_key=True)
    fecha_y_hora = db.Column(db.DateTime, default=datetime.utcnow)
    texto = db.Column(db.TEXT)
    
with app.app_context():
    db.create_all()
    
#Funcion para ordenar los registros por fecha y hora
def ordenar_por_fecha_y_hora(registros):
    return sorted(registros, key=lambda x: x.fecha_y_hora,reverse=True)

@app.route('/')
def index():
    #obtener todos los registros ed la base de datos
    registros = Log.query.all()
    registros_ordenados = ordenar_por_fecha_y_hora(registros)
    return render_template('index.html',registros=registros_ordenados)

mensajes_log = []

#Funcion para agregar mensajes y guardar en la base de datos
def agregar_mensajes_log(texto):
    mensajes_log.append(texto)

    #Guardar el mensaje en la base de datos
    nuevo_registro = Log(texto=texto)
    db.session.add(nuevo_registro)
    db.session.commit()

TOKEN_MC = "MOUNTAINCONQUEROR"

@app.route('/webhook', methods=['GET','POST'])
def webhook():
    if request.method == 'GET':
        challenge = verificar_token(request)
        return challenge
    elif request.method == 'POST':
        reponse = recibir_mensajes(request)
        return reponse

def verificar_token(req):
    token = req.args.get('hub.verify_token')
    challenge = req.args.get('hub.challenge')

    if challenge and token == TOKEN_MC:
        return challenge
    else:
        return jsonify({'error':'Token Invalido'}),401

def recibir_mensajes(req):
    try:
        req = request.get_json()
        entry =req['entry'][0]
        changes = entry['changes'][0]
        value = changes['value']
        objeto_mensaje = value['messages']

        if objeto_mensaje:
            messages = objeto_mensaje[0]

            if "type" in messages:
                tipo = messages["type"]

                #Guardar Log en la BD
                agregar_mensajes_log(json.dumps(messages))

                if tipo == "interactive":
                    tipo_interactivo = messages["interactive"]["type"]

                    if tipo_interactivo == "button_reply":
                        text = messages["interactive"]["button_reply"]["id"]
                        numero = messages["from"]

                        enviar_mensajes_whatsapp(text,numero)
                    
                    elif tipo_interactivo == "list_reply":
                        text = messages["interactive"]["list_reply"]["id"]
                        numero = messages["from"]

                        enviar_mensajes_whatsapp(text,numero)

                if "text" in messages:
                    text = messages["text"]["body"]
                    numero = messages["from"]

                    enviar_mensajes_whatsapp(text,numero)

                    #Guardar Log en la BD
                    agregar_mensajes_log(json.dumps(messages))

        return jsonify({'message':'EVENT_RECEIVED'})
    except Exception as e:
        return jsonify({'message':'EVENT_RECEIVED'})

def enviar_mensajes_whatsapp(texto,number):
    texto = texto.lower()

    if "hola" in texto:
        data={
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "üöÄ Hola, ¬øC√≥mo est√°s? Bienvenido."
            }
        }
    elif "1" in texto:
        data={
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "text": {
                "preview_url": True,
                "body": "Estos ser√°n nuestros pr√≥ximos tours! https://mountainconqueror.club/tours"
            }
        }
    elif "2" in texto:
        data = {
            "messaging_product": "whatsapp",
            "to": number,
            "type": "location",
            "location": {
                "latitude": "14.622405",
                "longitude": "-90.549373",
                "name": "Punto de reuni√≥n Centro Comercial Rus Mall",
                "address": "Centro Comercial Rus Mall"
            }
        }
    elif "3" in texto:
        data = {
            "messaging_product": "whatsapp",
            "to": number,
            "type": "location",
            "location": {
                "latitude": "14.854814",
                "longitude": "-91.536485",
                "name": "Punto de reuni√≥n Shell ‚Ä¢ Rotonda Paseo Las Americas",
                "address": "Shell ‚Ä¢ Rotonda Paseo Las Americas"
            }
        }
    elif "4" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "üôã‚Äç‚ôÇÔ∏è Hola soy asistente de Sebas, lamento que no hayas encontrado la informaci√≥n que buscabas y solicitas apoyo para resolver tus dudas. \n\nüìå *Puedesde escribirme a mi n√∫mero persona y con gust√≥ te atender√©.* \n\n +502 30247344"
            }
        }    
    elif "5" in texto:
        data ={
            "messaging_product": "whatsapp",
            "to": number,
            "type": "interactive",
            "interactive":{
                "type" : "list",
                "body": {
                    "text": "Seleccionar Lista"
                },
                "footer": {
                    "text": "Selecciona el listado de eventos pr√≥ximos"
                },
                "action":{
                    "button":"Ver Eventos",
                    "sections":[
                        {
                            "title":"Eventos",
                            "rows":[
                                {
                                    "id":"1l",
                                    "title" : "Volcanes 7 Orejas, Cerro Quemado + Cerro El Granizo",
                                    "description": "Enero 31 - Febrero 02 (Campamento)"
                                },
                                {
                                    "id":"2l",
                                    "title" : "Volc√°n Pacaya",
                                    "description": "Febrero 09 (Atardecer)"
                                },
                                {
                                    "id":"3l",
                                    "title" : "Volc√°n Acatenango (Ruta Alotenango)",
                                    "description": "Febrero 08 - 09 (Asalto)"
                                },
                                {
                                    "id":"4l",
                                    "title" : "Volc√°n Santa Mar√≠a + Campana Abaj",
                                    "description": "Febrero 15 - 16 (Ruta Turistica - Asalto Nocturno)"
                                },
                                {
                                    "id":"5l",
                                    "title" : "Volc√°n Santa Mar√≠a + Campana Abaj",
                                    "description": "Febrero 15 - 16 (Ruta La Viergen - Asalto Nocturno)"
                                },
                                {
                                    "id":"6l",
                                    "title" : "Volc√°n Tajumulco",
                                    "description": "Febrero 09 (Asalto - Ruta San Sebasti√°n con acercamiento 4x4)"
                                }
                            ]
                        },{
                            "title":"Retos",
                            "rows":[
                                {
                                    "id":"1r",
                                    "title" : "Reto Jaguar",
                                    "description": "37 Cumbres 2025 (Guatemala)."
                                },
                                {
                                    "id":"2r",
                                    "title" : "Reto Maya",
                                    "description": "Rutas Extremas (Guatemala)."
                                },
                                {
                                    "id":"3r",
                                    "title" : "Reto Tigre",
                                    "description": "15 Volcanes El Salvador 2025"
                                },
                                {
                                    "id":"4r",
                                    "title" : "Reto Chivo",
                                    "description": "37 Cumbres 2025 (Guatemala) - Salida desde Xela"
                                }
                            ]
                        },{
                            "title":"Trail Running",
                            "rows":[
                                {
                                    "id":"1tr",
                                    "title" : "X SkyRace",
                                    "description": "Evento de Trail running a desarrollarse en el parque entre cerros, Quetzaltenango (Xela), con distancias de 10K -14K -24K -42K en los volcanes Cerro Quemado, Santa Mar√≠a, Siete Orejas. \n\n Abril 13 (2025)"
                                }
                            ]
                        }
                    ]
                }
            }
        }
    elif "0" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "üöÄ *¬°Hola!* Gracias por comunicarte con nosotros\n\nüìå *Selecciona una opci√≥n del men√∫ para continuar:*\n\n1Ô∏è‚É£ Pr√≥ximos Eventos ‚ùî\n2Ô∏è‚É£ Salida desde la Capital üìç\n3Ô∏è‚É£ Salida desde Xela üìç\n4Ô∏è‚É£ Hablar con un operador üôã‚Äç‚ôÇÔ∏è\n5Ô∏è‚É£ Informaci√≥n de Eventos y Retos üåã\n 0Ô∏è‚É£ Regresar al Men√∫ üïú\n\n‚ú® *Escribe el n√∫mero de la opci√≥n que deseas y te ayudaremos de inmediato.* \n\n\n üåê Visita nuestro sitio web:\n mountainconqueror.club"
            }
        }
    elif "boton" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "interactive",
            "interactive":{
                "type":"button",
                "body": {
                    "text": "¬øConfirmas tu registro?"
                },
                "footer": {
                    "text": "Selecciona una de las opciones"
                },
                "action": {
                    "buttons":[
                        {
                            "type": "reply",
                            "reply":{
                                "id":"btnsi",
                                "title":"Si"
                            }
                        },{
                            "type": "reply",
                            "reply":{
                                "id":"btnno",
                                "title":"No"
                            }
                        },{
                            "type": "reply",
                            "reply":{
                                "id":"btntalvez",
                                "title":"Tal Vez"
                            }
                        }
                    ]
                }
            }
        }
    elif "btnsi" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "Muchas Gracias por Aceptar."
            }
        }
    elif "btnno" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "Es una Lastima."
            }
        }
    elif "btntalvez" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "Estare a la espera."
            }
        }
        
    elif "1l" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/events/0.Volcanes_7_Orejas_Cerro_Quemado_Cerro_El_Granizo.pdf",
                "caption": (
                    "üåãüî• *¬°Aventura Triple: Siete Orejas, Cerro Quemado y Cerro El Granizo!* üî•üåã\n\n"
                    "Prep√°rate para una jornada √©pica en tres de las maravillas naturales m√°s fascinantes de Guatemala. "
                    "Esta traves√≠a te llevar√° desde las alturas del *Volc√°n Siete Orejas*, pasando por las formaciones "
                    "m√≠sticas del *Cerro Quemado*, hasta la imponencia del *Cerro El Granizo*, todo en una experiencia "
                    "que pondr√° a prueba tu resistencia y amor por la monta√±a. üèîÔ∏è‚ú®\n\n"
                    "üîπ *Volc√°n Siete Orejas*: Con sus siete cumbres, este volc√°n ofrece paisajes √∫nicos y una conexi√≥n profunda con la naturaleza. üåÑ\n"
                    "üîπ *Cerro Quemado*: Terrenos volc√°nicos y vistas espectaculares en una formaci√≥n cargada de historia y energ√≠a. üî•\n"
                    "üîπ *Cerro El Granizo*: La combinaci√≥n perfecta de desaf√≠o y recompensa con paisajes que te dejar√°n sin aliento. üå≥\n\n"
                    "‚úÖ *¬°No te pierdas esta incre√≠ble oportunidad!* Vive una experiencia inolvidable que combina aventura, naturaleza y el esp√≠ritu de superaci√≥n. üí™üêæ\n\n"
                    "#SieteOrejas #CerroQuemado #CerroElGranizo #Monta√±ismoGuatemala #Pasi√≥nPorLasAlturas #ConquistaTriple #Aventura√âpica"
                )
            }
        }
    elif "2l" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/events/1.Volcan_Pacaya_Atardecer.pdf",
                "caption": (
                    "üåãüî• *¬°Cupo Lleno para el Volc√°n Pacaya!* üî•üåã\n\n"
                    "¬°Gracias a todos los aventureros por su entusiasmo! üéâ Hemos llenado todos los cupos para esta incre√≠ble expedici√≥n "
                    "al *Volc√°n Pacaya*, uno de los destinos m√°s espectaculares y din√°micos de Guatemala. üèîÔ∏è‚ú®\n\n"
                    "Prep√°rense para vivir una experiencia inolvidable, caminando sobre paisajes √∫nicos, admirando r√≠os de lava petrificada "
                    "y disfrutando de vistas panor√°micas que quitan el aliento. üåÑüî• Cada paso en esta aventura ser√° un recuerdo imborrable.\n\n"
                    "‚ùó *Si no alcanzaste cupo esta vez, no te preocupes.* Muy pronto anunciaremos nuevas fechas y rutas para que puedas unirte "
                    "a nuestras pr√≥ximas expediciones. üö∂‚Äç‚ôÇÔ∏èüêæ\n\n"
                    "#Volc√°nPacaya #Aventura√âpica #Pasi√≥nPorLaMonta√±a #Monta√±ismoGuatemala #Esp√≠rituDeAventura"
                )
            }
        }
    elif "3l" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/events/2.Acatenango_Ruta_Alotenango.pdf",
                "caption": (
                    "üåãüî• *¬°Desaf√≠o Extremo en el Volc√°n Acatenango por la Ruta Alotenango!* üî•üåã\n\n"
                    "Este no es un ascenso cualquiera, es una *aventura extrema* reservada para los m√°s valientes y experimentados. "
                    "La *Ruta Alotenango* es conocida por ser desafiante, intensa y llena de emociones que pondr√°n a prueba tu resistencia f√≠sica y mental. üèîÔ∏èüí™\n\n"
                    "Si buscas superar tus l√≠mites, atravesar terrenos empinados y disfrutar de vistas espectaculares mientras conquistas una de las "
                    "cumbres m√°s imponentes de Guatemala, *esta es tu oportunidad*. üåÑ‚ú®\n\n"
                    "‚ö†Ô∏è *No apto para principiantes*: Este desaf√≠o requiere experiencia previa en monta√±ismo, excelente condici√≥n f√≠sica y determinaci√≥n "
                    "para enfrentar uno de los ascensos m√°s intensos de la regi√≥n.\n\n"
                    "‚ùì *¬øEst√°s listo para el reto?* ¬°√önete y demuestra de qu√© est√°s hecho en esta aventura inolvidable! üî•üêæ\n\n"
                    "#AcatenangoExtremo #RutaAlotenango #Aventura√âpica #Monta√±ismoGuatemala #Desaf√≠oDeAltura #NoParaPrincipiantes #ConquistaLasCimas"
                )
            }
        }
    elif "4l" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/events/3.Volcan_Santa_Maria_Turistica.pdf",
                "caption": (
                    "üåã‚ú® *¬°Aventura en el Volc√°n Santa Mar√≠a y Campana Abaj!* ‚ú®üåã\n\n"
                    "Prep√°rate para explorar una de las rutas m√°s espectaculares y accesibles de Guatemala: el *Volc√°n Santa Mar√≠a* "
                    "y la m√°gica experiencia en *Campana Abaj*. Este recorrido tur√≠stico combina paisajes impresionantes, historia cultural "
                    "y la belleza natural que solo este destino puede ofrecer. üèîÔ∏èüåø\n\n"
                    "üîπ *Volc√°n Santa Mar√≠a*: Con una de las vistas m√°s impresionantes hacia el volc√°n activo *Santiaguito*, este coloso "
                    "es una parada obligatoria para los amantes de las alturas y la naturaleza. üåÑüî•\n"
                    "üîπ *Campana Abaj*: Un lugar lleno de misticismo y tradici√≥n que conecta a los visitantes con la cultura y el legado "
                    "ancestral de la regi√≥n. Una experiencia inolvidable rodeada de paisajes √∫nicos. ‚ú®üå≥\n\n"
                    "‚ùì *¬øListo para esta aventura tur√≠stica?* √önete a este recorrido que combina naturaleza, cultura y la magia de nuestras "
                    "monta√±as. Una oportunidad para disfrutar del esplendor de Guatemala en su m√°ximo esplendor. üí™üêæ\n\n"
                    "#Volc√°nSantaMar√≠a #CampanaAbaj #AventuraTur√≠stica #NaturalezaYTradici√≥n #Monta√±ismoGuatemala #Pasi√≥nPorLaCultura"
                )
            }
        }
    elif "5l" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/events/4.Volcan_Santa_Maria_Ruta_La_Virgen.pdf",
                "caption": (
                    "üåãüî• *¬°Aventura Extrema: Ruta La Virgen al Volc√°n Santa Mar√≠a!* üî•üåã\n\n"
                    "Para los m√°s valientes y audaces, presentamos *Ruta La Virgen*, un recorrido desafiante, poco explorado "
                    "y dise√±ado exclusivamente para los m√°s intr√©pidos. Esta nueva ruta hacia el imponente *Volc√°n Santa Mar√≠a* "
                    "promete poner a prueba tu resistencia y esp√≠ritu aventurero mientras descubres senderos ocultos y paisajes "
                    "que pocos han visto. üèîÔ∏èüí™‚ú®\n\n"
                    "Con *terrenos escarpados, inclinaciones pronunciadas y una conexi√≥n inigualable con la naturaleza*, *Ruta La Virgen* "
                    "es el desaf√≠o perfecto para quienes buscan algo m√°s all√° de lo ordinario. Cada paso ser√° un logro, y la recompensa "
                    "final ser√° una experiencia que marcar√° tu vida. üåÑüî•\n\n"
                    "‚ö†Ô∏è *No es para principiantes:* Este recorrido exige preparaci√≥n f√≠sica, determinaci√≥n y el alma de un verdadero explorador.\n\n"
                    "‚ùì *¬øTe atreves a ser parte de esta traves√≠a √©pica?* La cima del *Santa Mar√≠a* te espera para escribir una nueva historia de "
                    "superaci√≥n y aventura. üêæüî•\n\n"
                    "#RutaLaVirgen #Volc√°nSantaMar√≠a #AventuraExtrema #SoloParaIntrepidos #Monta√±ismoGuatemala #ConquistaLasAlturas"
                )
            }
        }
    elif "6l" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/events/5.Volcan_Tajumulco_Ruta_San_Sebastian_Nocturno.pdf",
                "caption": (
                    "üåãüî• *¬°Conquista el techo de Centroam√©rica: Volc√°n Tajumulco!* üî•üåã\n\n"
                    "Prep√°rate para una de las expediciones m√°s emblem√°ticas de Guatemala: el ascenso al *Volc√°n Tajumulco*, "
                    "el punto m√°s alto de toda Centroam√©rica con *4,220 metros sobre el nivel del mar*. üèîÔ∏è‚ú®\n\n"
                    "Esta traves√≠a te llevar√° a trav√©s de *impresionantes paisajes monta√±osos, bosques de altura y cielos despejados* "
                    "que regalan *amaneceres y atardeceres de ensue√±o*. Cada paso en esta aventura pondr√° a prueba tu resistencia, "
                    "pero la recompensa en la cima ser√° inigualable. üåÑüí™\n\n"
                    "üåü *Lo que te espera en el Tajumulco:*\n"
                    "üîπ *Ascenso desafiante* con vistas panor√°micas inigualables.\n"
                    "üîπ *Amanecer desde la cima*, un espect√°culo de colores y nubes danzando bajo tus pies.\n"
                    "üîπ *Conexi√≥n con la naturaleza* y el esp√≠ritu aventurero que llevas dentro.\n\n"
                    "‚úÖ *No te pierdas esta oportunidad de conquistar el techo de Centroam√©rica* y ser parte de una experiencia inolvidable. "
                    "¬øEst√°s listo para el reto? üöÄüî•\n\n"
                    "#Volc√°nTajumulco #TechoDeCentroam√©rica #Aventura√âpica #Monta√±ismoGuatemala #SuperandoL√≠mites #ConquistandoCimas"
                )
            }
        }
    elif "1r" in texto:
        data={
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/rj.pdf",
                "caption": "Reto Jaguar"
            }
        }
    elif "2r" in texto:
        data={
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                    "link": "https://mountainconqueror.club/assets/document/rm.pdf",
                    "caption": "Reto Maya"
                }
            }
    elif "3r" in texto:
        data={
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/rt.pdf",
                "caption": "Reto Tigre"
            }
        }
    elif "4r" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "document",
            "document": {
                "link": "https://mountainconqueror.club/assets/document/rc.pdf",
                "caption": "Reto Chivo"
            }
        }
    elif "1tr" in texto:
        data = {
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "¬°Sum√©rgete en la emocionante experiencia de la X-SKYRACE! Este desaf√≠o te invita a conquistar elevaciones impresionantes y explorar la majestuosidad de terrenos monta√±osos a trav√©s de una competici√≥n de resistencia y determinaci√≥n. Prep√°rate para elevar tu esp√≠ritu y desafiar los l√≠mites en los 3 volcanes de Xela, Cerr√≥ Quemado, Santa Mar√≠a, Siete Orejas \n\n\n üåê Visita nuestra pagina:\n https://www.instagram.com/x_skyrace/"
            }
        }
    else:
        data={
            "messaging_product": "whatsapp",
            "recipient_type": "individual",
            "to": number,
            "type": "text",
            "text": {
                "preview_url": False,
                "body": "üöÄ *¬°Hola!* Gracias por comunicarte con nosotros\n\nüìå *Selecciona una opci√≥n del men√∫ para continuar:*\n\n1Ô∏è‚É£ Pr√≥ximos Eventos ‚ùî\n2Ô∏è‚É£ Salida desde la Capital üìç\n3Ô∏è‚É£ Salida desde Xela üìç\n4Ô∏è‚É£ Hablar con un operador üôã‚Äç‚ôÇÔ∏è\n5Ô∏è‚É£ Informaci√≥n de Eventos y Retos üåã\n 0Ô∏è‚É£ Regresar al Men√∫ üïú\n\n‚ú® *Escribe el n√∫mero de la opci√≥n que deseas y te ayudaremos de inmediato.* \n\n\n üåê Visita nuestro sitio web:\n mountainconqueror.club"
            }
        }

    data=json.dumps(data)

    headers = {
        "Content-Type" : "application/json",
        "Authorization" : "Bearer EAA3DvBSFw0oBOy6TUbXILZCO6YoSvCxn8LZCyKvAbLGP1XQpHUtImCuPKSlDipQUdCMsOlhiWIY3V37L8YfshOpbxN95kqDBFepgnygzG0Nqv0DwQWZByqxCg4IKbpO00bVHnoSnX4k0EoKIJMyHYXYwHaJhoNPqs2TGUi5N8pRCaq2zDBbYZC2ZBXsSymiIahRzGfPZCwA4ol2PqiCAbseld5NZA0l1XzQs08ZAKZAYD"
    }

    connection = http.client.HTTPSConnection("graph.facebook.com")

    try:
        connection.request("POST","/v21.0/557632224096092/messages", data, headers)
        response = connection.getresponse()
        print(response.status, response.reason)
    except Exception as e:
        agregar_mensajes_log(json.dumps(e))
    finally:
        connection.close()

if __name__=='__main__':
    app.run(host='0.0.0.0',port=80,debug=True)